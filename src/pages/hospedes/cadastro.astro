---
import Form from "../../components/Form.astro";
import SelectInput from "../../components/SelectInput.astro";
import TextInput from "../../components/TextInput.astro";
import Layout from "../../layouts/Layout.astro";
const response = await fetch(
  "https://servicodados.ibge.gov.br/api/v1/paises/{paises}"
);
const data = await response.json();
const countries = [
  ...new Set(data.map((country: any) => country.nome.abreviado)),
] as string[];
---

<Layout>
  <Form id="new-guest-form">
    <div slot="inputs" class="flex flex-col max-w-lg mx-auto">
      <TextInput id="document" label="Documento" />
      <TextInput id="name" label="Nome" />
      <TextInput id="surname" label="Sobrenome" />
      <SelectInput id="country" label="PaÃ­s" options={countries} />
      <TextInput id="phone" label="Telefone" />
    </div>
    <div slot="buttons" class="flex flex-col w-full items-center p-16">
      <button
        id="submit_button"
        class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded w-56"
        type="submit">Cadastrar</button
      >
    </div>
  </Form>
</Layout>

<script>
  import { getFormData } from "../../utils/getFormData";
  import { creationalGuestSchema } from "../../schemas/schemas";
  const form = document.getElementById("new-guest-form") as HTMLFormElement;

  form.addEventListener("submit", async (event) => {
    event.preventDefault();

    const formData = getFormData(form);
    const parse = await creationalGuestSchema.safeParseAsync(formData);

    if (parse.success) {
      console.log(parse.data);
    } else {
      console.log(parse.error.errors);
    }

    const response = await fetch("http://127.0.0.1:8000/hospedes", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify(formData),
    });

    if (response.status === 201) {
      window.location.href = "/hospedes";
    } else {
      const data = await response.json();
      console.log(response.status, data);
    }
  });
</script>
